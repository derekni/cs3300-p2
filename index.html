<html>
  <head>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      .font {
        font-size: 18px;
      }
      /* legend */
      .legend {
        font-size: 14px;
      }
      rect {
        stroke-width: 2;
      }

      /* chart */
      #chart {
        margin: 0 auto;
        position: relative;
        display: block;
      }

      /* tooltip */
      .tooltip {
        background: #eee;
        box-shadow: 0 0 5px #999999;
        color: #333;
        display: none;
        font-size: 18px;
        padding: 10px;
        position: absolute;
        text-align: center;
        top: 95px;
        width: 200px;
        z-index: 10;
      }
    </style>
  </head>
  <body>
    <h2>Visualizing statisitics of students admitted to Ivy League schools in Class of 2025</h2>
    <h3>Megan Jung (mj374), Derek Ni (dan82), Bhav Patel (bdp64), Josh Lundmark (jel299)</h3>
    <p>Graph 1: pie chart, shows population, hover or click to see breakdown and further subsections (and possibly zoom in)</p>
    <p>Graph 2: chart of USA, color is acceptance rate, size of dot is school size, hover to get some info, click to zoom in and get a picture of campus or mascot or smth</p>
    <p id="p1">
      <div id="chart"></div>
      <script>
        async function initialize() {
          const schools = await d3.csv("data/ivy_stats.csv", d3.autoType);
          console.log(schools)
          var chartWidth = 1200;
          var chartHeight = 600;

          // legend dimensions
          var legendRectSize = 25;
          var legendSpacing = 6;

          var color = d3.scaleOrdinal()
                            .domain(["Brown", "Cornell", "Columbia", "Yale", "Harvard", "Dartmouth", "Penn", "Princeton"])
                            .range(['#4E3629', '#B31B1B', '#9BCBEB', '#00356B', '#A41034', '#046A38', '#011F5B', '#FF671F']);

          var svg = d3.select('#chart')
            .append('svg')
            .attr('width', chartWidth) 
            .attr('height', chartHeight)
            .append('g')
            .attr('transform', 'translate(' + (chartWidth / 2) + ',' + (chartHeight / 2) + ')');

          var radius = Math.min(chartWidth, chartHeight) / 2;

          var arc = d3.arc()
            .innerRadius(0)
            .outerRadius(radius);

          var pie = d3.pie()
            .value( d=> { return d['Total Apps Accepted']; })

          // define tooltip
          var tooltip = d3.select('#chart')
            .append('div')                                     
            .attr('class', 'tooltip') 
          
          tooltip.append('div')                           
            .attr('class', 'school'); 
           
          tooltip.append('div')
            .attr('class', 'expected')                     

          tooltip.append('div')                     
            .attr('class', 'count');                   

          tooltip.append('div')  
            .attr('class', 'percent');

          schools.forEach( function(d) {
            d["Total Apps Accepted"] =+d["Total Apps Accepted"];
            d.enabled = true;
          });

          // creating the chart
          var path = svg.selectAll('path')
            .data(pie(schools))
            .enter()
            .append('path') 
            .attr('d', arc) 
            .attr('fill', d => { return color(d.data["Ivy League Colleges"]); })
            .each( d => { this._current - d; });

          path.on('mouseover', function(event) {     
            d3.select(this).transition().duration(200)
                            .attr("stroke", "white")
                            .attr("stroke-width", 5)
            var total = d3.sum(schools.map(function(d) {         
              return (d.enabled) ? d["Total Apps Accepted"] : 0; 
              })); 
            var student_enroll = event.target.__data__.data["Total Apps Accepted"]
            var school_name = event.target.__data__.data["Ivy League Colleges"]
            var student_expected = event.target.__data__.data["Expected Number of Students to Enroll"]

            var percent = Math.round(1000 * student_enroll / total) / 10;
            tooltip.select('.school').html(school_name)
                   .style('color', color(school_name))
                   .style('font-weight', 'bold');        
            tooltip.select('.expected').html("Expected to enroll: " + student_expected );    
            tooltip.select('.count').html("Students accepted: " + student_enroll);            
            tooltip.select('.percent').html("% of total: " + percent + '%'); 
            tooltip.style('display', 'block');               
          });                                                             

          path.on('mouseout', function() {    
            d3.select(this)
                  .transition().duration(200)
                  .attr("stroke-width", 0)
                  .style("z-index", "1000")                
            tooltip.style('display', 'none');
          });
          
          path.on('mousemove', function(event) {             
            tooltip.style('top', (event.layerY + 10) + 'px')
              .style('left', (event.layerX + 10) + 'px');
            });

          // define legend
          var legend = svg.selectAll('.legend')
            .data(color.domain())
            .enter() 
            .append('g')
            .attr('class', 'legend')
            .attr('transform', function(d, i) {                   
              var height = legendRectSize + legendSpacing;   
              var offset =  height * color.domain().length / 2;
              var horz = 18 * legendRectSize;
              var vert = i * height - offset; 
                return 'translate(' + horz + ',' + vert + ')'; 
            });

          // adding colored squares to legend
          legend.append('rect')                                   
            .attr('width', legendRectSize)                
            .attr('height', legendRectSize)                
            .style('fill', color)
            .style('stroke', "black") 
            
          // adding text to legend
          legend.append('text')                                    
            .attr('x', legendRectSize + legendSpacing)
            .attr('y', legendRectSize - legendSpacing)
            .text(function(d) { return d; }); // return label
        }
        initialize();
      </script>
    </p>
    <p id="bar chart">
        <svg id="barChart" height="500" width="600"></svg>
        <script>
        async function initialize2() {
            let admData = await d3.csv("data/ivy_stats.csv", d3.autoType);

            const svg2 = d3.select("svg#barChart");
            const width2 = svg2.attr("width");
            const height2 = svg2.attr("height");
            const margin2 = {top: 20, right: 20, bottom: 50, left: 50};
            const chartWidth2 = width2 - margin2.left - margin2.right;
            const chartHeight2 = height2 - margin2.top - margin2.bottom;

            let annotations2 = svg2.append("g").attr("id", "annotations");
            let chartArea2 = svg2.append("g").attr("id","chart-area2")
                               .attr('transform', `translate(${margin2.left},${margin2.top})`);

            let maxRate = 0;
            admData.forEach( (d, i) => {
                d['name'] = String(d['Ivy League Colleges']);
                d['ed'] = Number((d['Early Decision / Action Accept. Rate']).replace('%', ''));
                d['rd'] = Number((d['Regular Decision Accept. Rate']).replace('%', ''));
                d['oar'] = Number((d['Overall Accept. Rate']).replace('%', ''));
                if(d['ed'] > maxRate) {
                    maxRate = d['ed'];
                }
            });

            // Problem -> Princeton has a NaN value for ED admissions, can't figure out how to get
            // rid of that value without getting rid of all Princeton data. Not sure how to go about this

            //admData = admData.filter( (d) => {return d['name'] && (d['ed'] > 0) && d['rd'] && d['oar']});

            let xDom = ["Brown", "Columbia", "Cornell", "Yale", "Harvard", "Dartmouth", "Penn", "Princeton"];
            let xScale = d3.scaleBand()
                            .domain(xDom)
                            .range([0, chartWidth2])
                            .paddingInner(0.5)
                            .paddingOuter(0.5);

            let yScale = d3.scaleLinear().domain([0, maxRate]).range([chartHeight2, 0]);
            console.log(yScale(3.5));

            let leftAxis = d3.axisLeft(yScale);
            annotations2.append('g')
                .attr('transform', `translate(${margin2.left-10},${margin2.top})`)
                .call(leftAxis);

            let leftGridlines = d3.axisLeft(yScale)
                                  .tickSize(-chartWidth2-10)
                                  .tickFormat("");
            annotations2.append('g')
                .attr('transform', `translate(${margin2.left-10},${margin2.top})`)
                .attr("class", "y gridlines")
                .call(leftGridlines);

            let bottomAxis = d3.axisBottom(xScale);
            annotations2.append('g')
                .attr('transform', `translate(${margin2.left},${chartHeight2+margin2.top+10})`)
                .call(bottomAxis);

            // function updateBarsAnimated(key) {
            //   const data = admData[key];
            //   console.log(data);
            // }
            console.log(admData);
            function updateBarsAnimated(key) {
              const data = yearData[yearKey];
              console.log(data);

              const genres = d3.map(data, (d) => d.genre);
              const genreScale = d3
                .scaleBand()
                .domain(genres)
                .range([0, chartWidth])
                .padding(0.05);

              // Update and animate axes
              bottomAxis.scale(genreScale);
              bottomAxisG.transition().call(bottomAxis);

              // FOR WEDNESDAY:
              // Something is going on, still... Take a look between a few decades and think about how the rectangles
              //  are being re-used by the data join. Are they consistent? Does it match what the axis labels do?
              chartArea
                .selectAll("rect.bar")
                .data(data, (d) => d["genre"])
                .join(
                  (enter) =>
                    enter
                      .append("rect")
                      .attr("class", "bar")
                      .attr("fill", "steelblue")
                      .attr("x", (d) => genreScale(d.genre))
                      .attr("y", (d) => percentScale(d.percentpass))
                      .attr(
                        "height",
                        (d) => percentScale(0) - percentScale(d.percentpass)
                      )
                      .attr("width", genreScale.bandwidth())
                      .attr("opacity", 0) // Set opacity low, then animate to 1 to make them fade in
                      .call((enter) => enter.transition().attr("opacity", 1)),
                  (update) =>
                    update.call((update) =>
                      update
                        .transition() // Animate resizing and movement
                        .attr("fill", "steelblue")
                        .attr("x", (d) => genreScale(d.genre))
                        .attr("y", (d) => percentScale(d.percentpass))
                        .attr(
                          "height",
                          (d) => percentScale(0) - percentScale(d.percentpass)
                        )
                        .attr("width", genreScale.bandwidth())
                    ),
                  (exit) =>
                    exit.call((exit) =>
                      exit.transition().attr("opacity", 0).remove()
                    )
                );
            }

            console.log("admin data");
            console.log(admData);

            admData.forEach( (d, i) => {
                chartArea2.append('rect')
                    .attr('x', xScale(d['name']))
                    .attr('y', yScale(d['ed']))
                    .attr('width', xScale.bandwidth())
                    .attr('height', chartHeight2-yScale(d['ed']))
                    .style('fill', '#9BCBEB');
                chartArea2.append('rect')
                    .attr('x', xScale(d['name']))
                    .attr('y', yScale(d['oar']))
                    .attr('width', xScale.bandwidth())
                    .attr('height', chartHeight2-yScale(d['oar']))
                    .style('fill', '#3563C1');
                chartArea2.append('rect')
                    .attr('x', xScale(d['name']))
                    .attr('y', yScale(d['rd']))
                    .attr('width', xScale.bandwidth())
                    .attr('height', chartHeight2-yScale(d['rd']))
                    .style('fill', '#011F5B');
            })
        }
        initialize2();
        </script>
        <br>Note: no data available for Princeton ED Admissions</br>
        <br>Key: Lightest = Early Decision, Middle = Total Admissions, Darkest = Regular Decision</br>
    </p>
  </body>
</html>
